# API Security Ideas — seeker-rps

Ideas to secure access to the seeker-rps API (games, users, and future endpoints).

---

## 1. **Authenticate the app (API key / client credentials)**

- **Idea:** Require a shared secret (API key) or client credentials so only your official app can call the API.
- **Implementation:**  
  - API: Read `X-API-Key` (or `Authorization: Bearer <api_key>`) and reject requests without a valid key.  
  - Store the key in Android `BuildConfig` or in a config loaded at runtime (e.g. from a remote config or env).  
  - **Caution:** Keys in the APK can be extracted; use keys for rate limiting / abuse control rather than "secrets". Prefer short-lived tokens from a backend that validates the client.

---

## 2. **Rate limiting**

- **Idea:** Limit how many requests a client (or IP) can send per minute/hour to avoid abuse and DoS.
- **Implementation:**  
  - In Rust: use `tower-governor` or a custom middleware that counts requests per IP (or per API key) and returns `429 Too Many Requests` when the limit is exceeded.  
  - Apply stricter limits to anonymous or unauthenticated endpoints (e.g. create game, join by PIN).

---

## 3. **Verify wallet ownership (Sign-In With Solana)**

- **Idea:** For sensitive actions (create game, join game, submit move), ensure the caller owns the wallet they claim.
- **Implementation:**  
  - Client: Use Sign-In With Solana (SIWS) to get a signed message (e.g. "Create game at …").  
  - Send the signature + message + claimed `creator_pubkey` (or joiner’s pubkey) to the API.  
  - API: Verify the signature against the claimed public key and the expected message (nonce, timestamp, action).  
  - Only then create the game or add the user to the game. This prevents impersonation.

---

## 4. **PIN and game lifecycle**

- **Idea:** Keep the 4-digit PIN as a "join token", not a secret that grants full control.
- **Current:** PIN is generated by the API and returned when creating a game; the creator's wallet is stored with the game.
- **Recommendations:**  
  - **Expiration:** Optionally expire games (and their PINs) after a timeout (e.g. 24 h) if no second player joined.  
  - **Rate limit PIN guesses:** Limit how many "join by PIN" attempts an IP (or client) can do per minute to reduce brute-force on the PIN.  
  - **One creator per game:** Only the creator_pubkey can start/cancel the game; the PIN is only for joining.

---

## 5. **HTTPS and transport**

- **Idea:** All production traffic should use HTTPS so requests and responses (including API keys or tokens) are not readable on the network.
- **Implementation:**  
  - Serve the API behind TLS (e.g. reverse proxy, or Axum with TLS).  
  - In Android, use `https://` for `API_BASE_URL` in production and optionally use certificate pinning if you need to lock the app to your server.

---

## 6. **CORS**

- **Idea:** If the API is ever called from a web app, restrict CORS to your known origins instead of `Any`.
- **Implementation:**  
  - Replace `allow_origin(Any)` with a whitelist of origins (e.g. `https://your-app.com`).  
  - For a mobile-only API, CORS is less critical but tightening it is good practice.

---

## 7. **Input validation and abuse**

- **Idea:** Validate and sanitize all inputs to avoid injection, huge payloads, or invalid data.
- **Implementation:**  
  - Validate `creator_pubkey` / pubkey format (e.g. base58, length).  
  - Reject oversized bodies and limit array sizes.  
  - Use type-safe parsing (e.g. Serde) and return clear 400 errors for invalid input.

---

## 8. **Users and games (authorization)**

- **Idea:** MongoDB collections: `users` (field `pubkey`); `games` (`creator_pubkey`, `joiner_pubkey` optional until second player joins). Exactly 2 players per game. Tie actions to the authenticated wallet.
- **Implementation:**  
  - **Create game:** Require a valid SIWS proof for `creator_pubkey`; upsert into `users` by pubkey, insert into `games` with `creator_pubkey`, `joiner_pubkey: null`.  
  - **Join game:** Require SIWS for the joining wallet; verify PIN → get game; upsert into `users`, set `games.joiner_pubkey` to joiner’s pubkey.  
  - **Actions in game:** Only allow moves/cancel for the wallet that is `creator_pubkey` or `joiner_pubkey` of that game.

---

## Summary table

| Measure              | Purpose                          | Effort |
|----------------------|----------------------------------|--------|
| API key / client auth | Restrict who can call the API   | Low    |
| Rate limiting         | Prevent abuse / DoS              | Medium |
| SIWS verification     | Prove wallet ownership          | Medium |
| PIN expiration / limits | Reduce PIN abuse              | Low    |
| HTTPS                 | Confidentiality in production   | Low    |
| CORS whitelist        | Restrict web origins            | Low    |
| Input validation      | Safety and clear errors         | Low    |
| Users (pubkey) + games (creator_pubkey, joiner_pubkey) + authZ | Per-game, per-wallet actions | Medium |

Implementing **HTTPS**, **input validation**, **rate limiting**, and **SIWS for create/join** will give a solid base; then add API key and CORS as needed for your deployment and clients.
